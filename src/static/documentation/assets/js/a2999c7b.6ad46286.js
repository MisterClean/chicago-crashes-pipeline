"use strict";(self.webpackChunkchicago_crashes_pipeline_docs=self.webpackChunkchicago_crashes_pipeline_docs||[]).push([[167],{225:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"development/testing","title":"Testing & Quality","description":"Testing strategy, fixtures, and coverage expectations.","source":"@site/docs/development/testing.md","sourceDirName":"development","slug":"/development/testing","permalink":"/documentation/development/testing","draft":false,"unlisted":false,"editUrl":"https://github.com/MisterClean/chicago-crashes-pipeline/tree/main/docs/development/testing.md","tags":[],"version":"current","lastUpdatedAt":1758174418000,"sidebarPosition":2,"frontMatter":{"title":"Testing & Quality","sidebar_position":2,"description":"Testing strategy, fixtures, and coverage expectations."},"sidebar":"guideSidebar","previous":{"title":"Development Environment","permalink":"/documentation/development/environment"},"next":{"title":"Contributing","permalink":"/documentation/development/contributing"}}');var i=s(4848),r=s(8453);const a={title:"Testing & Quality",sidebar_position:2,description:"Testing strategy, fixtures, and coverage expectations."},c=void 0,o={},d=[{value:"Testing Strategy",id:"testing-strategy",level:2},{value:"Fixtures",id:"fixtures",level:2},{value:"Coverage Targets",id:"coverage-targets",level:2},{value:"Running Tests",id:"running-tests",level:2},{value:"Test Data",id:"test-data",level:2},{value:"Writing New Tests",id:"writing-new-tests",level:2},{value:"Test Structure",id:"test-structure",level:3},{value:"Testing Service Layer",id:"testing-service-layer",level:3},{value:"Testing API Endpoints",id:"testing-api-endpoints",level:3},{value:"Testing with Database",id:"testing-with-database",level:3},{value:"Mocking Patterns",id:"mocking-patterns",level:2},{value:"Mocking External APIs",id:"mocking-external-apis",level:3},{value:"Mocking Database Operations",id:"mocking-database-operations",level:3},{value:"Mocking Time-Dependent Code",id:"mocking-time-dependent-code",level:3},{value:"Integration Tests",id:"integration-tests",level:2},{value:"Database Integration Tests",id:"database-integration-tests",level:3},{value:"Running Integration Tests",id:"running-integration-tests",level:3},{value:"Linting &amp; Type Checking",id:"linting--type-checking",level:2},{value:"Testing the Admin Portal",id:"testing-the-admin-portal",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"testing-strategy",children:"Testing Strategy"}),"\n",(0,i.jsxs)(t.p,{children:["The project uses ",(0,i.jsx)(t.a,{href:"https://docs.pytest.org/",children:"pytest"})," for unit and integration tests with SQLAlchemy-backed fixtures."]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Layer"}),(0,i.jsx)(t.th,{children:"Examples"}),(0,i.jsx)(t.th,{children:"Notes"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Pure functions"}),(0,i.jsx)(t.td,{children:"Validators, utilities"}),(0,i.jsx)(t.td,{children:"Aim for deterministic, side-effect free tests"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Service layer"}),(0,i.jsxs)(t.td,{children:[(0,i.jsx)(t.code,{children:"SyncService"}),", ",(0,i.jsx)(t.code,{children:"JobService"})]}),(0,i.jsx)(t.td,{children:"Mock external dependencies (SODA API, Redis) using pytest fixtures"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"API routers"}),(0,i.jsxs)(t.td,{children:["FastAPI ",(0,i.jsx)(t.code,{children:"TestClient"})," assertions"]}),(0,i.jsx)(t.td,{children:"Validate status codes, schemas, and background task behaviour"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"fixtures",children:"Fixtures"}),"\n",(0,i.jsxs)(t.p,{children:["Key fixtures live in ",(0,i.jsx)(t.code,{children:"tests/conftest.py"}),":"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"session"})," / ",(0,i.jsx)(t.code,{children:"db_engine"})," \u2013 create isolated in-memory or temporary PostgreSQL databases."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"test_client"})," \u2013 FastAPI client with dependency overrides for external services."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"soda_responses"})," \u2013 stubbed SODA API payloads for deterministic sync tests."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Reuse these fixtures to avoid brittle setup code in individual tests."}),"\n",(0,i.jsx)(t.h2,{id:"coverage-targets",children:"Coverage Targets"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Maintain ",(0,i.jsx)(t.strong,{children:"80%+"})," line coverage for critical modules (",(0,i.jsx)(t.code,{children:"src/services"}),", ",(0,i.jsx)(t.code,{children:"src/api/routers"}),", ",(0,i.jsx)(t.code,{children:"src/validators"}),")."]}),"\n",(0,i.jsx)(t.li,{children:"Ensure each new feature includes corresponding tests. For regressions, add tests that fail without the fix."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"running-tests",children:"Running Tests"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"# All tests\nmake test\n# Or: pytest tests -v\n\n# With coverage report\npytest tests --cov=src --cov-report=term-missing\npytest tests --cov=src --cov-report=html  # HTML report at htmlcov/index.html\n\n# Run specific test file\npytest tests/test_soda_client.py -v\n\n# Run specific test function\npytest tests/test_soda_client.py::test_fetch_records -v\n\n# Run tests matching pattern\npytest -v -k test_sync\n\n# Run with verbose output and print statements\npytest -v -s\n\n# Run failed tests from last run\npytest --lf\n\n# Run tests in parallel (requires pytest-xdist)\npytest -n auto\n"})}),"\n",(0,i.jsx)(t.h2,{id:"test-data",children:"Test Data"}),"\n",(0,i.jsxs)(t.p,{children:["Large fixtures (crash samples, people, vehicles) reside in ",(0,i.jsx)(t.code,{children:"tests/fixtures/"}),". Keep them small and anonymised. For new datasets, prefer synthesised JSON snippets rather than copying full records."]}),"\n",(0,i.jsx)(t.h2,{id:"writing-new-tests",children:"Writing New Tests"}),"\n",(0,i.jsx)(t.h3,{id:"test-structure",children:"Test Structure"}),"\n",(0,i.jsx)(t.p,{children:"Follow the Arrange-Act-Assert pattern:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'def test_sanitize_coordinates():\n    """Test coordinate sanitization for Chicago bounds."""\n    # Arrange\n    sanitizer = DataSanitizer()\n    crash_data = {\n        "crash_record_id": "TEST123",\n        "latitude": "41.8781",  # Valid Chicago latitude\n        "longitude": "-87.6298"  # Valid Chicago longitude\n    }\n\n    # Act\n    result = sanitizer.sanitize_crash_record(crash_data)\n\n    # Assert\n    assert result["latitude"] == 41.8781\n    assert result["longitude"] == -87.6298\n    assert result["crash_record_id"] == "TEST123"\n'})}),"\n",(0,i.jsx)(t.h3,{id:"testing-service-layer",children:"Testing Service Layer"}),"\n",(0,i.jsx)(t.p,{children:"Example service test with mocked dependencies:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'import pytest\nfrom unittest.mock import AsyncMock, MagicMock\nfrom src.services.sync_service import SyncService\n\n@pytest.mark.asyncio\nasync def test_sync_crashes_success():\n    """Test successful crash sync."""\n    # Arrange\n    mock_soda_client = AsyncMock()\n    mock_soda_client.fetch_records.return_value = [\n        {"crash_record_id": "1", "crash_date": "2023-01-01"},\n        {"crash_record_id": "2", "crash_date": "2023-01-02"}\n    ]\n\n    service = SyncService(soda_client=mock_soda_client)\n\n    # Act\n    result = await service.sync_crashes(start_date="2023-01-01")\n\n    # Assert\n    assert result.success is True\n    assert result.records_processed == 2\n    mock_soda_client.fetch_records.assert_called_once()\n'})}),"\n",(0,i.jsx)(t.h3,{id:"testing-api-endpoints",children:"Testing API Endpoints"}),"\n",(0,i.jsx)(t.p,{children:"Use FastAPI's TestClient for route testing:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'from fastapi.testclient import TestClient\nfrom src.api.main import app\n\ndef test_health_endpoint():\n    """Test health check endpoint."""\n    client = TestClient(app)\n\n    response = client.get("/health")\n\n    assert response.status_code == 200\n    assert response.json()["status"] == "healthy"\n'})}),"\n",(0,i.jsx)(t.h3,{id:"testing-with-database",children:"Testing with Database"}),"\n",(0,i.jsx)(t.p,{children:"Use pytest fixtures for database tests:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'def test_create_job(db_session):\n    """Test job creation in database."""\n    from src.models.jobs import Job\n\n    # Create job\n    job = Job(\n        name="Test Sync",\n        job_type="sync",\n        config={"endpoint": "crashes"}\n    )\n    db_session.add(job)\n    db_session.commit()\n\n    # Verify\n    retrieved = db_session.query(Job).filter_by(name="Test Sync").first()\n    assert retrieved is not None\n    assert retrieved.job_type == "sync"\n'})}),"\n",(0,i.jsx)(t.h2,{id:"mocking-patterns",children:"Mocking Patterns"}),"\n",(0,i.jsx)(t.h3,{id:"mocking-external-apis",children:"Mocking External APIs"}),"\n",(0,i.jsx)(t.p,{children:"Mock SODA API responses using pytest fixtures:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'# tests/conftest.py\n@pytest.fixture\ndef mock_soda_response():\n    """Mock SODA API response."""\n    return [\n        {\n            "crash_record_id": "123",\n            "crash_date": "2023-01-01T10:00:00",\n            "latitude": "41.8781",\n            "longitude": "-87.6298"\n        }\n    ]\n\n@pytest.fixture\ndef mock_soda_client(mock_soda_response):\n    """Mock SODA client."""\n    client = AsyncMock()\n    client.fetch_records.return_value = mock_soda_response\n    return client\n'})}),"\n",(0,i.jsx)(t.p,{children:"Usage in tests:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"async def test_with_mocked_api(mock_soda_client):\n    service = SyncService(soda_client=mock_soda_client)\n    result = await service.sync_crashes()\n    assert result.records_processed > 0\n"})}),"\n",(0,i.jsx)(t.h3,{id:"mocking-database-operations",children:"Mocking Database Operations"}),"\n",(0,i.jsx)(t.p,{children:"Mock database queries without hitting the actual database:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"from unittest.mock import MagicMock, patch\n\ndef test_database_operation():\n    with patch('src.services.database_service.Session') as mock_session:\n        mock_db = MagicMock()\n        mock_session.return_value = mock_db\n\n        # Test your service\n        service = DatabaseService()\n        result = service.get_crashes(limit=10)\n\n        # Verify database was called correctly\n        mock_db.query.assert_called_once()\n"})}),"\n",(0,i.jsx)(t.h3,{id:"mocking-time-dependent-code",children:"Mocking Time-Dependent Code"}),"\n",(0,i.jsxs)(t.p,{children:["Use ",(0,i.jsx)(t.code,{children:"freezegun"})," for time-based tests:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'from freezegun import freeze_time\nfrom datetime import datetime\n\n@freeze_time("2023-01-15 12:00:00")\ndef test_date_filtering():\n    """Test with frozen time."""\n    service = SyncService()\n    # Code that uses datetime.now() will always see 2023-01-15 12:00:00\n    assert datetime.now().day == 15\n'})}),"\n",(0,i.jsx)(t.h2,{id:"integration-tests",children:"Integration Tests"}),"\n",(0,i.jsx)(t.h3,{id:"database-integration-tests",children:"Database Integration Tests"}),"\n",(0,i.jsx)(t.p,{children:"Test full database workflow:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'@pytest.mark.integration\ndef test_full_sync_workflow(db_session):\n    """Test complete sync from API to database."""\n    # This test hits the real database (slower, more comprehensive)\n    service = SyncService()\n\n    # Run sync\n    result = service.sync_crashes(start_date="2023-01-01", end_date="2023-01-02")\n\n    # Verify data in database\n    from src.models.crashes import Crash\n    crashes = db_session.query(Crash).filter(\n        Crash.crash_date >= "2023-01-01"\n    ).all()\n\n    assert len(crashes) > 0\n    assert all(c.crash_record_id for c in crashes)\n'})}),"\n",(0,i.jsx)(t.h3,{id:"running-integration-tests",children:"Running Integration Tests"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'# Run only integration tests\npytest -m integration\n\n# Skip integration tests (faster for CI)\npytest -m "not integration"\n\n# Run integration tests with verbose output\npytest -m integration -v -s\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Configure in ",(0,i.jsx)(t.code,{children:"pytest.ini"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ini",children:"[pytest]\nmarkers =\n    integration: marks tests as integration tests (slower, hits database)\n    unit: marks tests as unit tests (fast, mocked dependencies)\n"})}),"\n",(0,i.jsx)(t.h2,{id:"linting--type-checking",children:"Linting & Type Checking"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"flake8 src tests\nmypy src\n"})}),"\n",(0,i.jsxs)(t.p,{children:["CI should fail on lint violations or type errors. When type stubs are missing for third-party libraries, annotate ",(0,i.jsx)(t.code,{children:"# type: ignore[import]"})," and leave a TODO to replace with proper typing later."]}),"\n",(0,i.jsx)(t.h2,{id:"testing-the-admin-portal",children:"Testing the Admin Portal"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Use Playwright or Cypress for end-to-end smoke tests if UI coverage is required."}),"\n",(0,i.jsxs)(t.li,{children:["For quick manual tests, run ",(0,i.jsx)(t.code,{children:"npm install && npm run start"})," inside the docs site to preview documentation changes alongside the API."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Document notable edge cases uncovered during testing so they can be promoted to automated coverage."})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>a,x:()=>c});var n=s(6540);const i={},r=n.createContext(i);function a(e){const t=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);